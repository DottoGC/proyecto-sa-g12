"use strict";var express=require("express");const path=require("path"),fs=require("fs");var jwt=require("jsonwebtoken"),app=express(),logger=fs.createWriteStream("./src/log.txt",{flags:"a"}),today=new Date,date=today.getFullYear()+"-"+(today.getMonth()+1)+"-"+today.getDate(),time=today.getHours()+":"+today.getMinutes()+":"+today.getSeconds();function addLog(o){logger.write(date+" "+time+" - "+o+"\n")}const mysql=require("mysql"),con=mysql.createConnection({host:"db-micro",port:3306,user:"root",password:"root",database:"projectsa"});con.connect((function(o){o&&console.log(o),console.log("Connected!")}));var privateKey=fs.readFileSync("./src/private.key","utf8"),payload={};console.log("Payload: "+JSON.stringify(payload));var exp="60s",signOptions={expiresIn:exp,algorithm:"RS256"};console.log("Options: "+JSON.stringify(signOptions)),console.log("\n"),app.get("/",(function(o,e){con.query("select * from microservicios",(o,e)=>{o&&console.log(o),console.log(e[0].client_id)}),e.send("Servidor de Tokens")})),app.post("/token",(function(o,e){var s=new Buffer((o.headers.authorization||"").split(" ")[1]||"","base64").toString().split(":");console.log(s[0]),console.log(s[1]),addLog(">> Usuario que esta pidiendo un token: "+s);var n="select scopes from microservicios where client_id=".concat("'").concat(s[0]).concat("'").concat(" and client_secret=".concat("'").concat(s[1]).concat("'"));console.log(n);var t=void 0;con.query(n,(o,s)=>{if(o&&console.log(o),t=s[0],console.log(t),void 0===t)return e.writeHead(401,{"Basic-Authenticate":'Basic realm="nope"'}),e.end("HTTP Error 401 Unauthorized: Access is denied"),void addLog(">> HTTP Error 401 Unauthorized: Access is denied");console.log(t),console.log(t.scopes),console.log(t.scopes.split(",")),payload.scopes=t.scopes.split(","),addLog(">> Scopes del usuario: "+payload.scopes),jwt.sign(payload,privateKey,signOptions,(o,s)=>{addLog(">> Token que se enviara: "+s),addLog(">>"),e.json({jwt:s})})})})),app.post("/tokens",(function(o,e){var s=new Buffer((o.headers.authorization||"").split(" ")[1]||"","base64").toString().split(":");console.log(s[0]),console.log(s[1]),addLog(">> Usuario que esta pidiendo un token: "+s);var n="select scopes from microservicios where client_id=".concat("'").concat(o.query.id).concat("'").concat(" and client_secret=".concat("'").concat(o.query.secret).concat("'"));console.log(n);var t=void 0;con.query(n,(o,s)=>{if(o&&console.log(o),t=s[0],console.log(t),void 0===t)return e.writeHead(401,{"Basic-Authenticate":'Basic realm="nope"'}),e.end("HTTP Error 401 Unauthorized: Access is denied"),void addLog(">> HTTP Error 401 Unauthorized: Access is denied");console.log(t),console.log(t.scopes),console.log(t.scopes.split(",")),payload.scopes=t.scopes.split(","),addLog(">> Scopes del usuario: "+payload.scopes),jwt.sign(payload,privateKey,signOptions,(o,s)=>{addLog(">> Token que se enviara: "+s),addLog(">>"),e.json({jwt:s})})})})),app.listen(8080,(function(){console.log("Servidor de Tokens, listening on port 8080!"),addLog(">> Servidor de Tokens, listening on port 8080 in docker and 80 in vm!")}));